---
AWSTemplateFormatVersion: "2010-09-09"
Conditions:
  CertificateKeyARN:
      Fn::Equals:
        - Ref: CertificateKeyARNParameter
        - 'true'

Description: Create Instance Profile for running Packer AEM
Parameters:
  PackerAemS3BucketParameter:
    Type: String
    Description: Name of the S3 Bucket where the artifacts are to be stored
  StackPrefixParameter:
    Default: ''
    Description: Used to Namespace the Exported Resources
    Type: String
  AEMLicenseParameter:
    Default: 'change-me'
    Description: AEM License for Deployment
    Type: String
  AEMKeyStorePasswordParameter:
    Comment: "TODO: Move to SecureString when it is supported on AWS Cloudformation. For more information see: https://aws.amazon.com/about-aws/whats-new/2018/08/aws-cloudformation-introduces-dynamic-references-to-support-aws-/"
    Description: Java Keystore password used in AEM Author and Publish
    Type: String
  CertificateKeyARNParameter:
    Description: The ARN of the Certificate in the AWS Certificate Manager
    Type: String

Resources:

  PackerAemArtefactBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref PackerAemS3BucketParameter

  AEMLicense:
    Type: AWS::SSM::Parameter
    Properties:
      Value: !Ref AEMLicenseParameter
      Type: String

  AEMKeystorePassword:
    Type: AWS::SSM::Parameter
    Properties:
      Value: !Ref AEMKeyStorePasswordParameter
      Type: String

  CertificateKeyARN:
    Type: AWS::SecretsManager::Secret
    Properties:
      SecretString: !Ref CertificateKeyARNParameter

  PackerAemBucketPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
        - Action: ['s3:GetObject', 's3:ListBucket']
          Effect: Allow
          Resource:
          - !Join ['', ['arn:aws:s3:::', !Ref 'PackerAemArtefactBucket']]
      PolicyName: PackerAemBucketPolicy
      Roles: [!Ref 'PackerAemRole']

  PackerAemRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      Policies:
        - PolicyName: PackerAemRolePolicy
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - acm:GetCertificate
                  - ec2:AttachVolume
                  - ec2:AuthorizeSecurityGroupIngress
                  - ec2:CopyImage
                  - ec2:CreateImage
                  - ec2:CreateKeypair
                  - ec2:CreateSecurityGroup
                  - ec2:CreateSnapshot
                  - ec2:CreateTags
                  - ec2:CreateVolume
                  - ec2:DeleteKeypair
                  - ec2:DeleteSecurityGroup
                  - ec2:DeleteSnapshot
                  - ec2:DeleteVolume
                  - ec2:DeregisterImage
                  - ec2:DescribeImageAttribute
                  - ec2:DescribeImages
                  - ec2:DescribeInstances
                  - ec2:DescribeRegions
                  - ec2:DescribeSecurityGroups
                  - ec2:DescribeSnapshots
                  - ec2:DescribeSubnets
                  - ec2:DescribeTags
                  - ec2:DescribeVolumes
                  - ec2:DetachVolume
                  - ec2:GetPasswordData
                  - ec2:ModifyImageAttribute
                  - ec2:ModifyInstanceAttribute
                  - ec2:ModifySnapshotAttribute
                  - ec2:RegisterImage
                  - ec2:RunInstances
                  - ec2:StopInstances
                  - ec2:TerminateInstances
                  - iam:PassRole
                  - kms:Decrypt
                  - secretsmanager:GetSecretValue
                  - ssm:GetParameterHistory
                  - ssm:GetParametersByPath
                  - ssm:GetParameters
                  - ssm:GetParameter
                Resource: "*"
              - Effect: Allow
                Action:
                  - s3:*
                Resource: "*"
              - Effect: Allow
                Action:
                  - logs:*
                Resource:
                  - arn:aws:logs:*:*:*

  PackerAemInstanceProfile:
      Type: AWS::IAM::InstanceProfile
      Properties:
        Path: /
        Roles:
          - Ref: PackerAemRole
